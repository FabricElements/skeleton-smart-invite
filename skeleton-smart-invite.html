<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icons/communication-icons.html">
<link rel="import" href="../iron-icons/notification-icons.html">
<link rel="import" href="./icons/app.html">

<dom-module id="skeleton-smart-invite">
  <template>
    <style is="custom-style">
      :host {
        display: block;
      }

      [hidden] {
        display: none !important;
      }

      #value-icon {
        margin-right: 0.5rem;
      }

      #status-icon {
        margin-left: 0.5rem;
        color: var(--paper-green-500);
      }

      #status-icon.sync {
        transform: rotate(45deg);
        color: var(--paper-grey-500);

        -webkit-animation: spin 4s linear infinite;
        -moz-animation: spin 4s linear infinite;
        animation: spin 4s linear infinite;
      }

      @-moz-keyframes spin {
        100% {
          -moz-transform: rotate(-360deg);
        }
      }

      @-webkit-keyframes spin {
        100% {
          -webkit-transform: rotate(-360deg);
        }
      }

      @keyframes spin {
        100% {
          -webkit-transform: rotate(-360deg);
          transform: rotate(-360deg);
        }
      }

      #status-icon[invalid] {
        color: var(--error-color);
      }

      paper-button {
        background-color: var(--paper-blue-a200);
        color: white;
        position: relative;
        bottom: 0.3rem;
        --paper-button: {
          padding: 0.3rem;
        };
      }

      paper-button iron-icon {
        margin-left: 0.8rem;
        transform: rotate(-45deg);
        position: relative;
        bottom: 0.1rem;
      }
    </style>
    <paper-input value="{{value}}"
                 label="[[label]]"
                 type="text"
                 prevent-invalid-input
                 minlength="4"
                 error-message="[[errorMessage]]"
                 invalid="{{invalid}}"
                 autocomplete="on"
    >
      <iron-icon icon="[[iconType]]" slot="prefix" id="value-icon"></iron-icon>
      <iron-icon class$="[[iconValidationClass]]" icon="[[iconValidation]]" slot="suffix" hidden$="[[iconHidden]]"
                 invalid$="[[invalid]]" id="status-icon"></iron-icon>
      <paper-button raised slot="suffix" hidden$="[[buttonHidden]]" on-tap="_invite">INVITE
        <iron-icon icon="send"></iron-icon>
      </paper-button>
    </paper-input>
  </template>

  <script>
    /**
     * `skeleton-smart-invite`
     *
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class SkeletonSmartInvite extends Polymer.Element {
      /**
       * @return {string}
       */
      static get is() {
        return 'skeleton-smart-invite';
      }

      /**
       * @return {object}
       */
      static get properties() {
        return {
          label: {
            type: String,
            value: 'Mobile number or email',
          },
          errorMessage: {
            type: String,
            value: 'Invalid value',
          },
          value: {
            type: String,
            value: null,
            reflectToAttribute: true,
            notify: true,
            observer: '_valueObserver',
          },
          invalid: {
            type: Boolean,
            value: false,
            reflectToAttribute: true,
            notify: true,
          },
          iconHidden: {
            type: Boolean,
            value: true,
          },
          buttonHidden: {
            type: Boolean,
            value: true,
          },
          iconValidation: {
            type: String,
            value: null,
          },
          iconType: {
            type: String,
            value: 'info',
          },
          loading: {
            type: Boolean,
            value: false,
            observer: '_loadingObserver',
          },
          errorPhone: {
            type: String,
            value: 'Invalid phone number',
          },
          errorEmail: {
            type: String,
            value: 'Invalid email',
          },
          iconValidationClass: {
            type: String,
            value: null,
          },
          sent: {
            type: Boolean,
            value: false,
          },
        };
      }

      /**
       * Validation icon
       *
       * @param {boolean} status
       * @return {string}
       * @private
       */
      _computeValidationIcon(status) {
        return status ? 'close' : 'check';
      }

      _valueObserver(value) {
        let isValidPhone = false;
        let isValidEmail = false;
        this.iconType = 'info';
        if (!value) return;
        if (value.length < 3) {
          this.iconType = 'info';
        } else {
          this.invalid = true;
          this.buttonHidden = true;
        }
        isValidPhone = this._validatePhone(value);
        if (isValidPhone) {
          console.log('Its a valid PHONE!');
          this.iconType = 'communication:phone';
          this.invalid = false;
          this.buttonHidden = false;
          return isValidPhone;
        }
        isValidEmail = this._validateEmail(value);
        if (isValidEmail) {
          console.log('Its a valid EMAIL!');
          this.iconType = 'communication:email';
          this.invalid = false;
          this.buttonHidden = false;
          return isValidEmail;
        }
        return false;
      }

      _validateEmail(text) {
        let re = /^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,4}$/;
        return re.test(text);
      }

      _validatePhone(text) {
        let re = /^(?:\+)([0-9]{1,3})([0-9]{9,10})$/;
        return re.test(text);
      }

      _invite() {
        this.iconValidation = 'notification:sync';
        this.iconValidationClass = 'sync';
        this.loading = true;
        setTimeout(() => {
          this.loading = false;
          this.iconValidationClass = '';
          this.iconValidation = 'check';
          this.iconHidden = false;
          this.sent = true;
        }, 3000);
      }

      _loadingObserver(loading) {
        if (loading) {
          this.iconHidden = false;
          this.buttonHidden = true;
        } else {
          this.iconHidden = true;
        }
      }

    }

    window.customElements.define(SkeletonSmartInvite.is, SkeletonSmartInvite);
  </script>
</dom-module>
